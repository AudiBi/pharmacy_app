{% extends "base.html" %}

{% block title %}Dashboard Admin{% endblock %}

{% block head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Socket.IO client -->
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  #alerts {
    max-height: 150px;
    overflow-y: auto;
  }
  .alert-item {
    padding: 0.3rem 0.5rem;
    border-bottom: 1px solid #ddd;
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h1 class="mb-4">Dashboard Admin</h1>

  <div class="row mb-4">
    <!-- Stock total -->
    <div class="col-md-3">
      <div class="card text-white bg-primary mb-3">
        <div class="card-header"><i class="fas fa-boxes"></i> Stock total</div>
        <div class="card-body">
          <h5 class="card-title">{{ total_stock }} M√©dicaments</h5>
        </div>
      </div>
    </div>

    <!-- Ventes du jour -->
    <div class="col-md-3">
      <div class="card text-white bg-success mb-3">
        <div class="card-header"><i class="fas fa-cash-register"></i> Ventes du jour</div>
        <div class="card-body">
          <h5 class="card-title">{{ ventes_du_jour }} m√©dicaments vendus</h5>
        </div>
      </div>
    </div>

    <!-- Alertes -->
    <div class="col-md-3">
      <div class="card text-white bg-warning mb-3">
        <div class="card-header"><i class="fas fa-exclamation-triangle"></i> Alertes</div>
        <div class="card-body" id="alerts">
          {% if alerts %}
            {% for alert in alerts %}
            <div class="alert-item alert alert-warning" role="alert">{{ alert }}</div>
            {% endfor %}
          {% else %}
            <div>Aucune alerte</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Produits proches de la date de p√©remption -->
    <div class="col-md-3">
      <div class="card text-white bg-danger mb-3">
        <div class="card-header"><i class="fas fa-calendar-times"></i> Prochaines p√©remptions</div>
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            {% for drug, days_left in near_expiry %}
              <li>
                <strong>{{ drug.name }}</strong> - expire dans {{ days_left }} jours
              </li>
            {% else %}
              <li>Aucun produit proche de la p√©remption</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Top 5 M√©dicaments -->
  <div class="card mb-4">
    <div class="card-header"><i class="fas fa-pills"></i> Top 5 M√©dicaments les plus vendus</div>
    <div class="card-body">
      <ol>
        {% for drug_name, qty in top5_meds %}
          <li>{{ drug_name }} - {{ qty }} ventes</li>
        {% else %}
          <li>Aucune donn√©e disponible</li>
        {% endfor %}
      </ol>
    </div>
  </div>


  <!-- Card Graphique -->
  <div class="card">
    <div class="card-header">üìä Chiffre d'affaires cumul√© par heure</div>
    <div class="card-body">
      <canvas id="salesChart" width="400" height="200"></canvas>
    </div>
  </div>
</div>
<script id="sales-data" type="application/json">
{
  "labels": {{ sales_labels | tojson | safe }},
  "data": {{ sales_data | tojson | safe }}
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // R√©cup√©ration des donn√©es JSON dans le DOM
  const jsonData = JSON.parse(document.getElementById('sales-data').textContent);
  const salesLabels = jsonData.labels;
  const salesData = jsonData.data;

  const ctx = document.getElementById('salesChart').getContext('2d');
  const salesChart = new Chart(ctx, {
      type: 'line',
      data: {
          labels: salesLabels,
          datasets: [{
              label: "Chiffre d'affaires (HTG)",
              data: salesData,
              borderColor: 'rgba(54, 162, 235, 1)',
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              fill: true,
              tension: 0.3
          }]
      },
      options: {
          responsive: true,
          scales: {
              x: { title: { display: true, text: 'Heure' } },
              y: { title: { display: true, text: 'Montant (HTG)' }, beginAtZero: true }
          }
      }
  });
</script>

{% endblock %}
