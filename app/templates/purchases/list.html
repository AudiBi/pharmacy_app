<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Gestion des achats</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="p-4">

<h1>Gestion des achats</h1>

<!-- Formulaire création / édition -->
<form id="purchase-form" class="mb-4">
    <input type="hidden" id="purchase-id" />
    <div class="mb-3">
        <label for="supplier" class="form-label">Fournisseur</label>
        <select id="supplier" class="form-select" required></select>
    </div>
    <div class="mb-3">
        <label for="drug" class="form-label">Médicament</label>
        <select id="drug" class="form-select" required></select>
    </div>
    <div class="mb-3">
        <label for="quantity" class="form-label">Quantité</label>
        <input type="number" id="quantity" class="form-control" min="1" required />
    </div>
    <div class="mb-3">
        <label for="unit_price" class="form-label">Prix unitaire</label>
        <input type="number" id="unit_price" class="form-control" min="0" step="0.01" required />
    </div>
    <div class="mb-3">
        <label for="commentaire" class="form-label">Commentaire</label>
        <textarea id="commentaire" class="form-control"></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Enregistrer</button>
    <button type="button" id="cancel-btn" class="btn btn-secondary ms-2">Annuler</button>
</form>

<!-- Liste achats -->
<table class="table table-striped" id="purchases-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Fournisseur</th>
            <th>Médicament</th>
            <th>Quantité</th>
            <th>Prix unitaire</th>
            <th>Coût total</th>
            <th>Commentaire</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
const apiUrl = '/purchases';  // Ajuster si besoin selon prefixe Flask

async function fetchSuppliers() {
    // Ici il faudrait une route API /suppliers renvoyant JSON [{id, name}, ...]
    const res = await fetch('/suppliers');
    return await res.json();
}

async function fetchDrugs() {
    // Pareil pour /drugs
    const res = await fetch('/drugs');
    return await res.json();
}

async function loadSelectOptions() {
    const suppliers = await fetchSuppliers();
    const drugs = await fetchDrugs();

    const supplierSelect = document.getElementById('supplier');
    supplierSelect.innerHTML = suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

    const drugSelect = document.getElementById('drug');
    drugSelect.innerHTML = drugs.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
}

async function loadPurchases() {
    const res = await fetch(apiUrl);
    const purchases = await res.json();

    const tbody = document.querySelector('#purchases-table tbody');
    tbody.innerHTML = purchases.map(p => `
        <tr>
            <td>${p.id}</td>
            <td>${p.supplier}</td>
            <td>${p.drug}</td>
            <td>${p.quantity}</td>
            <td>${p.unit_price.toFixed(2)}</td>
            <td>${p.total_cost.toFixed(2)}</td>
            <td>${p.commentaire || ''}</td>
            <td>
                <button class="btn btn-sm btn-info" onclick="editPurchase(${p.id})">Modifier</button>
                <button class="btn btn-sm btn-danger" onclick="deletePurchase(${p.id})">Supprimer</button>
            </td>
        </tr>
    `).join('');
}

async function editPurchase(id) {
    const res = await fetch(`${apiUrl}/${id}`);
    if (!res.ok) {
        alert('Erreur lors du chargement');
        return;
    }
    const p = await res.json();
    document.getElementById('purchase-id').value = p.id;
    document.getElementById('supplier').value = p.supplier_id;
    document.getElementById('drug').value = p.drug_id;
    document.getElementById('quantity').value = p.quantity;
    document.getElementById('unit_price').value = p.unit_price;
    document.getElementById('commentaire').value = p.commentaire || '';
}

async function deletePurchase(id) {
    if (!confirm('Confirmer la suppression ?')) return;
    const res = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
    if (res.ok) {
        alert('Supprimé');
        loadPurchases();
    } else {
        alert('Erreur suppression');
    }
}

document.getElementById('purchase-form').addEventListener('submit', async e => {
    e.preventDefault();

    const id = document.getElementById('purchase-id').value;
    const data = {
        supplier_id: parseInt(document.getElementById('supplier').value),
        drug_id: parseInt(document.getElementById('drug').value),
        quantity: parseInt(document.getElementById('quantity').value),
        unit_price: parseFloat(document.getElementById('unit_price').value),
        commentaire: document.getElementById('commentaire').value
    };

    let url = apiUrl;
    let method = 'POST';
    if (id) {
        url += `/${id}`;
        method = 'PUT';
    }

    const res = await fetch(url, {
        method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });

    if (res.ok) {
        alert(id ? 'Modifié avec succès' : 'Créé avec succès');
        resetForm();
        loadPurchases();
    } else {
        const errorData = await res.json();
        alert('Erreur: ' + JSON.stringify(errorData.errors || errorData.error || errorData));
    }
});

document.getElementById('cancel-btn').addEventListener('click', e => {
    e.preventDefault();
    resetForm();
});

function resetForm() {
    document.getElementById('purchase-id').value = '';
    document.getElementById('purchase-form').reset();
}

window.onload = async () => {
    await loadSelectOptions();
    await loadPurchases();
};
</script>

</body>
</html>
