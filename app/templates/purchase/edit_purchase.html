{% extends "base.html" %}

{% block title %}Modifier l'achat{% endblock %}

{% block content %}
<div class="container mt-5">

    <!-- En-tête -->
    <div class="bg-success bg-opacity-10 p-3 rounded mb-4">
        <h2 class="text-success fw-bold mb-0">
            <i class="bi bi-pencil-square me-2"></i> Modifier un achat
        </h2>
        <small class="text-muted">Mettre à jour les détails de l'achat existant</small>
    </div>

    {% if form.errors %}
    <div class="alert alert-danger">
        <h5 class="mb-2">Veuillez corriger les erreurs ci-dessous :</h5>
        <ul class="mb-0">
            {% for field, errs in form.errors.items() %}
                <li><strong>{{ field }} :</strong> {{ errs|join(', ') }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="POST" novalidate class="shadow-sm p-4 rounded bg-light">
        {{ form.hidden_tag() }}

        <!-- Fournisseur -->
        <div class="mb-3">
            {{ form.supplier_id.label(class="form-label fw-semibold") }}
            {{ form.supplier_id(class="form-select") }}
            {% for error in form.supplier_id.errors %}
                <div class="text-danger small">{{ error }}</div>
            {% endfor %}
        </div>

        <!-- Date d'achat -->
        <div class="mb-3">
            {{ form.purchase_date.label(class="form-label fw-semibold") }}
            {{ form.purchase_date(class="form-control") }}
            {% for error in form.purchase_date.errors %}
                <div class="text-danger small">{{ error }}</div>
            {% endfor %}
        </div>

        <!-- Commentaire -->
        <div class="mb-4">
            {{ form.commentaire.label(class="form-label fw-semibold") }}
            {{ form.commentaire(class="form-control", rows=3) }}
            {% for error in form.commentaire.errors %}
                <div class="text-danger small">{{ error }}</div>
            {% endfor %}
        </div>

        <!-- Produits achetés -->
        <div class="bg-white border rounded p-3 mb-4">
            <h5 class="fw-bold mb-3"><i class="bi bi-capsule me-1"></i> Produits achetés</h5>
            <div id="items">
                {% for subform in form.items %}
                <div class="card mb-3 p-3 product-item shadow-sm">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-5">
                            {{ subform.form.drug_id.label(class="form-label fw-semibold") }}
                            {{ subform.form.drug_id(class="form-select") }}
                            {% for error in subform.form.drug_id.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-2">
                            {{ subform.form.quantity.label(class="form-label fw-semibold") }}
                            {{ subform.form.quantity(class="form-control", min=1) }}
                            {% for error in subform.form.quantity.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-3">
                            {{ subform.form.unit_price.label(class="form-label fw-semibold") }}
                            {{ subform.form.unit_price(class="form-control", step="0.01", min=0) }}
                            {% for error in subform.form.unit_price.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-2 d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-danger remove-item">
                                <i class="bi bi-x-lg"></i> Supprimer
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <button type="button" class="btn btn-outline-secondary mb-3" id="add-item">
                <i class="bi bi-plus-circle me-1"></i> Ajouter un produit
            </button>
        </div>

        <!-- Bouton de soumission -->
        <div class="d-grid">
            {{ form.submit(class="btn btn-success fw-semibold") }}
        </div>
    </form>
</div>

<!-- Modal : Au moins un produit requis -->
<div class="modal fade" id="minProductModal" tabindex="-1" aria-labelledby="minProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-success">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="minProductModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i> Attention
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                Vous devez conserver <strong>au moins un produit</strong> dans l'achat.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Compris</button>
            </div>
        </div>
    </div>
</div>

<!-- JS gestion dynamique des items -->
<script>
document.getElementById('add-item').addEventListener('click', function () {
    const itemsDiv = document.getElementById('items');
    const allItems = itemsDiv.querySelectorAll('.product-item');
    const lastItem = allItems[allItems.length - 1];
    const newItem = lastItem.cloneNode(true);

    let totalItems = allItems.length;

    newItem.querySelectorAll('select, input').forEach(input => {
        input.value = '';
        let name = input.name;
        if (name) {
            input.name = name.replace(/\d+/, totalItems);
            input.id = input.name;
        }
    });

    itemsDiv.appendChild(newItem);
});

document.addEventListener('click', function (event) {
    if (event.target.classList.contains('remove-item') || event.target.closest('.remove-item')) {
        const itemsDiv = document.getElementById('items');
        if (itemsDiv.children.length > 1) {
            event.target.closest('.product-item').remove();
        } else {
            const modal = new bootstrap.Modal(document.getElementById('minProductModal'));
            modal.show();
        }
    }
});
</script>
{% endblock %}
